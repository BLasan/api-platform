# --------------------------------------------------------------------
# Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# --------------------------------------------------------------------

static_resources:
  listeners:
    - name: header-router-8081
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8081
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http_8081
                route_config:
                  name: header-based-routing
                  virtual_hosts:
                    - name: all-domains
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/webhook"
                            headers:
                              - name: ":method"
                                string_match:
                                  safe_regex:
                                    regex: "^(POST|GET)$"
                          route:
                            cluster: service_1
                        - match:
                            prefix: "/"
                          direct_response:
                            status: 405
                            body:
                              inline_string: "Method Not Allowed. Only POST and GET supported."
                http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
    - name: websubhub-router-9091
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9091
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http_9091
                route_config:
                  name: websubhub-routing
                  virtual_hosts:
                    - name: all-domains
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: endpoint_websubhub
                            prefix_rewrite: "/hub"
                          # request_headers_to_add:
                          #   - header:
                          #       key: "Content-Type"
                          #       value: "application/x-www-form-urlencoded"
                          #     append_action: OVERWRITE_IF_EXISTS_OR_ADD
                          #   - header:
                          #       key: "x-ballerina-publisher"
                          #       value: "publish"
                          #     append_action: OVERWRITE_IF_EXISTS_OR_ADD
                http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
    - name: dynamic-forward-proxy-8082
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8082
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http_8082
                codec_type: AUTO
                route_config:
                  name: dynamic-forward-proxy-routing
                  virtual_hosts:
                    - name: all-domains
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy_cluster
                            timeout: 30s
                            retry_policy:
                              retry_on: "5xx,reset,connect-failure,refused-stream"
                              num_retries: 1
                http_filters:
                  - name: envoy.filters.http.ext_proc
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                      grpc_service:
                        envoy_grpc:
                          cluster_name: ext-processor-grpc-service
                        timeout: 0.250s
                      failure_mode_allow: false
                      processing_mode:
                        request_header_mode: SEND
                        response_header_mode: SEND
                        request_trailer_mode: SEND
                        response_trailer_mode: SEND
                        # https://www.envoyproxy.io/docs/envoy/v1.33.0/api-v3/extensions/filters/http/ext_proc/v3/processing_mode.proto#envoy-v3-api-enum-extensions-filters-http-ext-proc-v3-processingmode-bodysendmode
                        request_body_mode: BUFFERED
                        response_body_mode: BUFFERED
                      message_timeout:
                        seconds: 20
                        nanos: 250000000
                  - name: envoy.filters.http.dynamic_forward_proxy
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.FilterConfig
                      dns_cache_config:
                        name: dynamic_forward_proxy_cache_config
                        dns_lookup_family: V4_ONLY
                        max_hosts: 1024
                        dns_refresh_rate: 60s
                        dns_min_refresh_rate: 5s
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
  clusters:
    - name: xds_cluster
      type: STRICT_DNS
      connect_timeout: 1s
      typed_extension_protocol_options:
        envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
          "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
          explicit_http_config:
            http2_protocol_options: {}
      load_assignment:
        cluster_name: xds_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: ${XDS_SERVER_HOST}
                      port_value: ${XDS_SERVER_PORT}
    - name: service_1
      type: STRICT_DNS
      connect_timeout: 1s
      load_assignment:
        cluster_name: service_1
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: host.docker.internal
                      port_value: 2000
    - name: endpoint_websubhub
      type: STRICT_DNS
      connect_timeout: 1s
      load_assignment:
        cluster_name: endpoint_websubhub
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: host.docker.internal
                      port_value: 9098
    - name: dynamic_forward_proxy_cluster
      lb_policy: CLUSTER_PROVIDED
      connect_timeout: 5s
      cluster_type:
        name: envoy.clusters.dynamic_forward_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
          dns_cache_config:
            name: dynamic_forward_proxy_cache_config
            dns_lookup_family: V4_ONLY
            max_hosts: 1024
            dns_refresh_rate: 60s
            dns_min_refresh_rate: 5s
      upstream_connection_options:
        tcp_keepalive:
          keepalive_time: 300
    - name: ext-processor-grpc-service
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      typed_extension_protocol_options:
        envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
          "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
          explicit_http_config:
            http2_protocol_options: {}
      load_assignment:
        cluster_name: ext-processor-grpc-service
        endpoints:
        - lb_endpoints:
          - endpoint:
              address:
                socket_address:
                  address: host.docker.internal
                  port_value: 9001
